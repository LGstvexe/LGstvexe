name: Atualizar README com últimos repositórios

on:
  schedule:
    - cron: '0 0 * * *'  # roda todo dia à meia-noite UTC
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checar código
      uses: actions/checkout@v3

    - name: Buscar últimos repositórios e atualizar README
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_USERNAME: LGstvexe
      run: |
        # Instalar jq (para processar JSON)
        sudo apt-get install jq

        # Buscar últimos 2 repos do usuário (ordenados por criação)
        repos=$(curl -s "https://api.github.com/users/$GITHUB_USERNAME/repos?sort=created&direction=desc&per_page=2")

        # Gerar cards em markdown para os repos
        cards=""
        for row in $(echo "${repos}" | jq -r '.[] | @base64'); do
          _jq() {
            echo "${row}" | base64 --decode | jq -r "${1}"
          }
          name=$(_jq '.name')
          url=$(_jq '.html_url')
          cards+="[![Repo Card](https://github-readme-stats.vercel.app/api/pin/?username=$GITHUB_USERNAME&repo=$name&style=for-the-badge)]($url)\n"
        done

        # Atualizar o README.md substituindo uma seção delimitada
        awk -v cards="$cards" '
          /<!--START_REPOS-->/ {print; print cards; getline; getline; next}
          {print}
        ' README.md > README.tmp

        mv README.tmp README.md

        # Commit e push se mudou o README
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git diff --cached --quiet || git commit -m "Atualiza cards dos últimos repositórios"
        git push